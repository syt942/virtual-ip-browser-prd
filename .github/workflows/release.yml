name: Build and Release v1.3.0

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to build (e.g., 1.3.0)'
        required: true
        default: '1.3.0'

env:
  NODE_VERSION: '20'

jobs:
  # ============================================
  # Pre-Build Validation
  # ============================================
  validate:
    name: Pre-Build Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: TypeScript check
        run: npm run typecheck

      - name: Lint check
        run: npm run lint

      - name: Run unit tests
        run: npm test -- --run

      - name: Verify version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "Package version: $VERSION"
          if [ "$VERSION" != "1.3.0" ]; then
            echo "Warning: Version mismatch"
          fi

  # ============================================
  # Linux Builds
  # ============================================
  build-linux:
    name: Build Linux Packages
    needs: validate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Linux build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y rpm

      - name: Build application
        run: npm run build

      - name: Package for Linux (AppImage)
        run: npm run package:linux -- --linux AppImage

      - name: Package for Linux (deb)
        run: npm run package:linux -- --linux deb

      - name: Package for Linux (rpm)
        run: npm run package:linux -- --linux rpm

      - name: Generate checksums
        run: |
          cd release
          sha256sum *.AppImage *.deb *.rpm > SHA256SUMS-linux.txt
          cat SHA256SUMS-linux.txt

      - name: Upload Linux artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-packages
          path: |
            release/*.AppImage
            release/*.deb
            release/*.rpm
            release/SHA256SUMS-linux.txt
          retention-days: 30

  # ============================================
  # Windows Builds
  # ============================================
  build-windows:
    name: Build Windows Packages
    needs: validate
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: npm run build

      - name: Package for Windows (NSIS Installer)
        run: npm run package:win -- --win nsis
        env:
          # Code signing certificate (configure in repository secrets)
          CSC_LINK: ${{ secrets.WIN_CSC_LINK }}
          CSC_KEY_PASSWORD: ${{ secrets.WIN_CSC_KEY_PASSWORD }}

      - name: Package for Windows (Portable)
        run: npm run package:win -- --win portable

      - name: Generate checksums
        shell: pwsh
        run: |
          cd release
          Get-ChildItem -Filter "*.exe" | ForEach-Object {
            $hash = (Get-FileHash $_.FullName -Algorithm SHA256).Hash.ToLower()
            "$hash  $($_.Name)" | Out-File -Append SHA256SUMS-windows.txt -Encoding utf8
          }
          Get-Content SHA256SUMS-windows.txt

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-packages
          path: |
            release/*.exe
            release/SHA256SUMS-windows.txt
          retention-days: 30

  # ============================================
  # macOS Builds
  # ============================================
  build-macos:
    name: Build macOS Packages
    needs: validate
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: npm run build

      - name: Package for macOS (DMG)
        run: npm run package:mac -- --mac dmg
        env:
          # Apple code signing (configure in repository secrets)
          CSC_LINK: ${{ secrets.MAC_CSC_LINK }}
          CSC_KEY_PASSWORD: ${{ secrets.MAC_CSC_KEY_PASSWORD }}
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}

      - name: Package for macOS (ZIP)
        run: npm run package:mac -- --mac zip

      - name: Generate checksums
        run: |
          cd release
          shasum -a 256 *.dmg *.zip > SHA256SUMS-macos.txt
          cat SHA256SUMS-macos.txt

      - name: Upload macOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-packages
          path: |
            release/*.dmg
            release/*.zip
            release/SHA256SUMS-macos.txt
          retention-days: 30

  # ============================================
  # Create GitHub Release
  # ============================================
  release:
    name: Create GitHub Release
    needs: [build-linux, build-windows, build-macos]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release files
        run: |
          mkdir -p release-files
          cp artifacts/linux-packages/* release-files/ || true
          cp artifacts/windows-packages/* release-files/ || true
          cp artifacts/macos-packages/* release-files/ || true
          
          # Combine all checksums
          cd release-files
          cat SHA256SUMS-*.txt > SHA256SUMS.txt 2>/dev/null || true
          rm -f SHA256SUMS-*.txt
          
          echo "Release files:"
          ls -la

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          name: Virtual IP Browser v1.3.0
          body_path: RELEASE_NOTES.md
          draft: true
          prerelease: false
          files: |
            release-files/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ============================================
  # Post-Build Verification
  # ============================================
  verify:
    name: Post-Build Verification
    needs: [build-linux, build-windows, build-macos]
    runs-on: ubuntu-latest
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Verify artifacts
        run: |
          echo "=== Linux Packages ==="
          ls -lh artifacts/linux-packages/ || echo "No Linux packages"
          
          echo ""
          echo "=== Windows Packages ==="
          ls -lh artifacts/windows-packages/ || echo "No Windows packages"
          
          echo ""
          echo "=== macOS Packages ==="
          ls -lh artifacts/macos-packages/ || echo "No macOS packages"
          
          echo ""
          echo "=== All Checksums ==="
          cat artifacts/*/SHA256SUMS-*.txt 2>/dev/null || echo "No checksums found"

      - name: Verify package sizes
        run: |
          echo "Verifying package sizes are within expected ranges..."
          
          # Linux AppImage: 100-180MB expected
          APPIMAGE_SIZE=$(stat -f%z artifacts/linux-packages/*.AppImage 2>/dev/null || stat -c%s artifacts/linux-packages/*.AppImage 2>/dev/null || echo "0")
          echo "AppImage size: $APPIMAGE_SIZE bytes"
          
          # Linux deb: 70-120MB expected
          DEB_SIZE=$(stat -f%z artifacts/linux-packages/*.deb 2>/dev/null || stat -c%s artifacts/linux-packages/*.deb 2>/dev/null || echo "0")
          echo "DEB size: $DEB_SIZE bytes"
          
          # Linux rpm: 70-120MB expected
          RPM_SIZE=$(stat -f%z artifacts/linux-packages/*.rpm 2>/dev/null || stat -c%s artifacts/linux-packages/*.rpm 2>/dev/null || echo "0")
          echo "RPM size: $RPM_SIZE bytes"
          
          echo "Package size verification complete"
